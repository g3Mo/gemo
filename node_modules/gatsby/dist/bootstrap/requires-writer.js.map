{"version":3,"sources":["../../src/bootstrap/requires-writer.js"],"names":["_","require","path","fs","crypto","slash","store","emitter","reporter","match","lastHash","resetLastHash","pickComponentFields","page","pick","getComponents","pages","map","uniqBy","c","componentChunkName","value","getMatchPaths","createMatchPathEntry","index","score","matchPath","replace","split","length","wildcard","includes","matchPathPages","forEach","push","isInsideMatchPath","find","pageWithMatchPath","sort","a","b","wildcardOrder","order","createHash","matchPaths","components","update","JSON","stringify","digest","writeAll","state","program","values","newHash","syncRequires","component","join","asyncRequires","relativeComponentPath","relative","directory","writeAndMove","file","data","destination","tmp","Date","now","writeFile","then","move","overwrite","Promise","all","debouncedWriteAll","debounce","activity","activityTimer","id","start","didRequiresChange","getState","pendingActivity","end","leading","startListener","on","module","exports"],"mappings":"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","sourcesContent":["const _ = require(`lodash`)\nconst path = require(`path`)\nconst fs = require(`fs-extra`)\nconst crypto = require(`crypto`)\nconst slash = require(`slash`)\nconst { store, emitter } = require(`../redux/`)\nconst reporter = require(`gatsby-cli/lib/reporter`)\nconst { match } = require(`@reach/router/lib/utils`)\nimport { joinPath } from \"gatsby-core-utils\"\n\nlet lastHash = null\n\nconst resetLastHash = () => {\n  lastHash = null\n}\n\nconst pickComponentFields = page =>\n  _.pick(page, [`component`, `componentChunkName`])\n\nconst getComponents = pages =>\n  _(pages)\n    .map(pickComponentFields)\n    .uniqBy(c => c.componentChunkName)\n    .value()\n\n/**\n * Get all dynamic routes and sort them by most specific at the top\n * code is based on @reach/router match utility (https://github.com/reach/router/blob/152aff2352bc62cefc932e1b536de9efde6b64a5/src/lib/utils.js#L224-L254)\n */\nconst getMatchPaths = pages => {\n  const createMatchPathEntry = (page, index) => {\n    let score = page.matchPath.replace(/[/][*]?$/, ``).split(`/`).length\n    let wildcard = 0\n\n    if (!page.matchPath.includes(`*`)) {\n      wildcard = 1\n      score += 1\n    }\n\n    return {\n      ...page,\n      index,\n      score,\n      wildcard,\n    }\n  }\n\n  const matchPathPages = []\n  pages.forEach((page, index) => {\n    if (page.matchPath) {\n      matchPathPages.push(createMatchPathEntry(page, index))\n    }\n  })\n\n  // Pages can live in matchPaths, to keep them working without doing another network request\n  // we save them in matchPath. Our sorting will put them above dynamic routes\n  // as we add a static bonus point to static routes\n  // More info in https://github.com/gatsbyjs/gatsby/issues/16097\n  // small speedup: don't bother traversing when no matchPaths found.\n  if (matchPathPages.length) {\n    pages.forEach((page, index) => {\n      const isInsideMatchPath = !!matchPathPages.find(\n        pageWithMatchPath =>\n          !page.matchPath && match(pageWithMatchPath.matchPath, page.path)\n      )\n\n      if (isInsideMatchPath) {\n        matchPathPages.push(\n          createMatchPathEntry(\n            {\n              ...page,\n              matchPath: page.path,\n            },\n            index\n          )\n        )\n      }\n    })\n  }\n\n  return matchPathPages\n    .sort((a, b) => {\n      // Paths with wildcards should appear after those without.\n      const wildcardOrder = b.wildcard - a.wildcard\n      if (wildcardOrder !== 0) {\n        return wildcardOrder\n      }\n\n      // The higher the score, the higher the specificity of our matchPath\n      const order = b.score - a.score\n      if (order !== 0) {\n        return order\n      }\n\n      // if specificity is the same we use the array index\n      return b.index - a.index\n    })\n    .map(({ path, matchPath }) => {\n      return { path, matchPath }\n    })\n}\n\nconst createHash = (matchPaths, components) =>\n  crypto\n    .createHash(`md5`)\n    .update(JSON.stringify({ matchPaths, components }))\n    .digest(`hex`)\n\n// Write out pages information.\nconst writeAll = async state => {\n  // console.log(`on requiresWriter progress`)\n  const { program } = state\n  const pages = [...state.pages.values()]\n  const matchPaths = getMatchPaths(pages)\n  const components = getComponents(pages)\n\n  const newHash = createHash(matchPaths, components)\n\n  if (newHash === lastHash) {\n    // Nothing changed. No need to rewrite files\n    // console.log(`on requiresWriter END1`)\n    return false\n  }\n\n  lastHash = newHash\n\n  // Create file with sync requires of components/json files.\n  let syncRequires = `const { hot } = require(\"react-hot-loader/root\")\n\n// prefer default export if available\nconst preferDefault = m => m && m.default || m\n\\n\\n`\n  syncRequires += `exports.components = {\\n${components\n    .map(\n      c =>\n        `  \"${c.componentChunkName}\": hot(preferDefault(require(\"${joinPath(\n          c.component\n        )}\")))`\n    )\n    .join(`,\\n`)}\n}\\n\\n`\n\n  // Create file with async requires of components/json files.\n  let asyncRequires = `// prefer default export if available\nconst preferDefault = m => m && m.default || m\n\\n`\n  asyncRequires += `exports.components = {\\n${components\n    .map(c => {\n      // we need a relative import path to keep contenthash the same if directory changes\n      const relativeComponentPath = path.relative(\n        path.join(program.directory, `.cache`),\n        c.component\n      )\n\n      return `  \"${c.componentChunkName}\": () => import(\"${slash(\n        relativeComponentPath\n      )}\" /* webpackChunkName: \"${c.componentChunkName}\" */)`\n    })\n    .join(`,\\n`)}\n}\\n\\n`\n\n  const writeAndMove = (file, data) => {\n    const destination = joinPath(program.directory, `.cache`, file)\n    const tmp = `${destination}.${Date.now()}`\n    return fs\n      .writeFile(tmp, data)\n      .then(() => fs.move(tmp, destination, { overwrite: true }))\n  }\n\n  await Promise.all([\n    writeAndMove(`sync-requires.js`, syncRequires),\n    writeAndMove(`async-requires.js`, asyncRequires),\n    writeAndMove(`match-paths.json`, JSON.stringify(matchPaths, null, 4)),\n  ])\n\n  return true\n}\n\nconst debouncedWriteAll = _.debounce(\n  async () => {\n    const activity = reporter.activityTimer(`write out requires`, {\n      id: `requires-writer`,\n    })\n    activity.start()\n    const didRequiresChange = await writeAll(store.getState())\n    if (didRequiresChange) {\n      reporter.pendingActivity({ id: `webpack-develop` })\n    }\n    activity.end()\n  },\n  500,\n  {\n    // using \"leading\" can cause double `writeAll` call - particularly\n    // when refreshing data using `/__refresh` hook.\n    leading: false,\n  }\n)\n\n/**\n * Start listening to CREATE/DELETE_PAGE events so we can rewrite\n * files as required\n */\nconst startListener = () => {\n  emitter.on(`CREATE_PAGE`, () => {\n    reporter.pendingActivity({ id: `requires-writer` })\n    debouncedWriteAll()\n  })\n\n  emitter.on(`CREATE_PAGE_END`, () => {\n    reporter.pendingActivity({ id: `requires-writer` })\n    debouncedWriteAll()\n  })\n\n  emitter.on(`DELETE_PAGE`, () => {\n    reporter.pendingActivity({ id: `requires-writer` })\n    debouncedWriteAll()\n  })\n\n  emitter.on(`DELETE_PAGE_BY_PATH`, () => {\n    reporter.pendingActivity({ id: `requires-writer` })\n    debouncedWriteAll()\n  })\n}\n\nmodule.exports = {\n  writeAll,\n  resetLastHash,\n  startListener,\n}\n"],"file":"requires-writer.js"}